#include "heart_control.h"

#include "hardware.h"
#include "heart_control_peripherals.h"
#include "heartbeat_data.h"

#define HC_NUM_LIGHTS 200

typedef struct {
	uint8_t b, r, g;
} hc_color_t;

typedef struct {
	int32_t r, g, b;
} hc_pal_color_t;

static size_t hc_audio_pos = 0;

static uint8_t const hc_cie_table[4096] = {
		  0,   0,   0,   0,   0,   0,   0,   0,
		  0,   0,   0,   0,   0,   0,   0,   0,
		  0,   0,   0,   0,   0,   0,   0,   0,
		  0,   0,   0,   0,   0,   0,   0,   0,
		  0,   0,   0,   0,   0,   0,   0,   0,
		  0,   0,   0,   0,   0,   0,   0,   0,
		  0,   0,   0,   0,   0,   0,   0,   0,
		  0,   0,   0,   0,   0,   0,   0,   0,
		  0,   0,   0,   0,   0,   0,   0,   0,
		  0,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   1,   1,   1,   1,   1,   1,
		  1,   1,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   2,   2,   2,   2,   2,   2,
		  2,   2,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   3,   3,   3,   3,   3,
		  3,   3,   3,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   4,   4,
		  4,   4,   4,   4,   4,   4,   5,   5,
		  5,   5,   5,   5,   5,   5,   5,   5,
		  5,   5,   5,   5,   5,   5,   5,   5,
		  5,   5,   5,   5,   5,   5,   5,   5,
		  5,   5,   5,   5,   5,   5,   5,   5,
		  5,   5,   5,   5,   5,   5,   5,   5,
		  5,   5,   5,   5,   5,   5,   5,   5,
		  5,   5,   5,   5,   5,   5,   5,   5,
		  5,   5,   5,   5,   5,   5,   5,   5,
		  5,   5,   5,   5,   5,   5,   5,   5,
		  5,   5,   5,   5,   5,   5,   5,   5,
		  5,   5,   5,   5,   6,   6,   6,   6,
		  6,   6,   6,   6,   6,   6,   6,   6,
		  6,   6,   6,   6,   6,   6,   6,   6,
		  6,   6,   6,   6,   6,   6,   6,   6,
		  6,   6,   6,   6,   6,   6,   6,   6,
		  6,   6,   6,   6,   6,   6,   6,   6,
		  6,   6,   6,   6,   6,   6,   6,   6,
		  6,   6,   6,   6,   6,   6,   6,   6,
		  6,   6,   6,   6,   6,   6,   6,   6,
		  6,   6,   6,   6,   6,   6,   6,   7,
		  7,   7,   7,   7,   7,   7,   7,   7,
		  7,   7,   7,   7,   7,   7,   7,   7,
		  7,   7,   7,   7,   7,   7,   7,   7,
		  7,   7,   7,   7,   7,   7,   7,   7,
		  7,   7,   7,   7,   7,   7,   7,   7,
		  7,   7,   7,   7,   7,   7,   7,   7,
		  7,   7,   7,   7,   7,   7,   7,   7,
		  7,   7,   7,   7,   7,   7,   7,   7,
		  7,   7,   7,   7,   8,   8,   8,   8,
		  8,   8,   8,   8,   8,   8,   8,   8,
		  8,   8,   8,   8,   8,   8,   8,   8,
		  8,   8,   8,   8,   8,   8,   8,   8,
		  8,   8,   8,   8,   8,   8,   8,   8,
		  8,   8,   8,   8,   8,   8,   8,   8,
		  8,   8,   8,   8,   8,   8,   8,   8,
		  8,   8,   8,   8,   8,   8,   8,   8,
		  8,   8,   9,   9,   9,   9,   9,   9,
		  9,   9,   9,   9,   9,   9,   9,   9,
		  9,   9,   9,   9,   9,   9,   9,   9,
		  9,   9,   9,   9,   9,   9,   9,   9,
		  9,   9,   9,   9,   9,   9,   9,   9,
		  9,   9,   9,   9,   9,   9,   9,   9,
		  9,   9,   9,   9,   9,   9,   9,   9,
		  9,   9,   9,   9,  10,  10,  10,  10,
		 10,  10,  10,  10,  10,  10,  10,  10,
		 10,  10,  10,  10,  10,  10,  10,  10,
		 10,  10,  10,  10,  10,  10,  10,  10,
		 10,  10,  10,  10,  10,  10,  10,  10,
		 10,  10,  10,  10,  10,  10,  10,  10,
		 10,  10,  10,  10,  10,  10,  10,  10,
		 10,  10,  11,  11,  11,  11,  11,  11,
		 11,  11,  11,  11,  11,  11,  11,  11,
		 11,  11,  11,  11,  11,  11,  11,  11,
		 11,  11,  11,  11,  11,  11,  11,  11,
		 11,  11,  11,  11,  11,  11,  11,  11,
		 11,  11,  11,  11,  11,  11,  11,  11,
		 11,  11,  11,  11,  12,  12,  12,  12,
		 12,  12,  12,  12,  12,  12,  12,  12,
		 12,  12,  12,  12,  12,  12,  12,  12,
		 12,  12,  12,  12,  12,  12,  12,  12,
		 12,  12,  12,  12,  12,  12,  12,  12,
		 12,  12,  12,  12,  12,  12,  12,  12,
		 12,  12,  12,  12,  13,  13,  13,  13,
		 13,  13,  13,  13,  13,  13,  13,  13,
		 13,  13,  13,  13,  13,  13,  13,  13,
		 13,  13,  13,  13,  13,  13,  13,  13,
		 13,  13,  13,  13,  13,  13,  13,  13,
		 13,  13,  13,  13,  13,  13,  13,  13,
		 13,  14,  14,  14,  14,  14,  14,  14,
		 14,  14,  14,  14,  14,  14,  14,  14,
		 14,  14,  14,  14,  14,  14,  14,  14,
		 14,  14,  14,  14,  14,  14,  14,  14,
		 14,  14,  14,  14,  14,  14,  14,  14,
		 14,  14,  14,  14,  15,  15,  15,  15,
		 15,  15,  15,  15,  15,  15,  15,  15,
		 15,  15,  15,  15,  15,  15,  15,  15,
		 15,  15,  15,  15,  15,  15,  15,  15,
		 15,  15,  15,  15,  15,  15,  15,  15,
		 15,  15,  15,  15,  15,  16,  16,  16,
		 16,  16,  16,  16,  16,  16,  16,  16,
		 16,  16,  16,  16,  16,  16,  16,  16,
		 16,  16,  16,  16,  16,  16,  16,  16,
		 16,  16,  16,  16,  16,  16,  16,  16,
		 16,  16,  16,  16,  17,  17,  17,  17,
		 17,  17,  17,  17,  17,  17,  17,  17,
		 17,  17,  17,  17,  17,  17,  17,  17,
		 17,  17,  17,  17,  17,  17,  17,  17,
		 17,  17,  17,  17,  17,  17,  17,  17,
		 17,  17,  18,  18,  18,  18,  18,  18,
		 18,  18,  18,  18,  18,  18,  18,  18,
		 18,  18,  18,  18,  18,  18,  18,  18,
		 18,  18,  18,  18,  18,  18,  18,  18,
		 18,  18,  18,  18,  18,  18,  19,  19,
		 19,  19,  19,  19,  19,  19,  19,  19,
		 19,  19,  19,  19,  19,  19,  19,  19,
		 19,  19,  19,  19,  19,  19,  19,  19,
		 19,  19,  19,  19,  19,  19,  19,  19,
		 19,  19,  20,  20,  20,  20,  20,  20,
		 20,  20,  20,  20,  20,  20,  20,  20,
		 20,  20,  20,  20,  20,  20,  20,  20,
		 20,  20,  20,  20,  20,  20,  20,  20,
		 20,  20,  20,  21,  21,  21,  21,  21,
		 21,  21,  21,  21,  21,  21,  21,  21,
		 21,  21,  21,  21,  21,  21,  21,  21,
		 21,  21,  21,  21,  21,  21,  21,  21,
		 21,  21,  21,  21,  22,  22,  22,  22,
		 22,  22,  22,  22,  22,  22,  22,  22,
		 22,  22,  22,  22,  22,  22,  22,  22,
		 22,  22,  22,  22,  22,  22,  22,  22,
		 22,  22,  22,  22,  23,  23,  23,  23,
		 23,  23,  23,  23,  23,  23,  23,  23,
		 23,  23,  23,  23,  23,  23,  23,  23,
		 23,  23,  23,  23,  23,  23,  23,  23,
		 23,  23,  23,  24,  24,  24,  24,  24,
		 24,  24,  24,  24,  24,  24,  24,  24,
		 24,  24,  24,  24,  24,  24,  24,  24,
		 24,  24,  24,  24,  24,  24,  24,  24,
		 24,  25,  25,  25,  25,  25,  25,  25,
		 25,  25,  25,  25,  25,  25,  25,  25,
		 25,  25,  25,  25,  25,  25,  25,  25,
		 25,  25,  25,  25,  25,  25,  26,  26,
		 26,  26,  26,  26,  26,  26,  26,  26,
		 26,  26,  26,  26,  26,  26,  26,  26,
		 26,  26,  26,  26,  26,  26,  26,  26,
		 26,  26,  26,  27,  27,  27,  27,  27,
		 27,  27,  27,  27,  27,  27,  27,  27,
		 27,  27,  27,  27,  27,  27,  27,  27,
		 27,  27,  27,  27,  27,  27,  28,  28,
		 28,  28,  28,  28,  28,  28,  28,  28,
		 28,  28,  28,  28,  28,  28,  28,  28,
		 28,  28,  28,  28,  28,  28,  28,  28,
		 28,  29,  29,  29,  29,  29,  29,  29,
		 29,  29,  29,  29,  29,  29,  29,  29,
		 29,  29,  29,  29,  29,  29,  29,  29,
		 29,  29,  29,  29,  30,  30,  30,  30,
		 30,  30,  30,  30,  30,  30,  30,  30,
		 30,  30,  30,  30,  30,  30,  30,  30,
		 30,  30,  30,  30,  30,  30,  31,  31,
		 31,  31,  31,  31,  31,  31,  31,  31,
		 31,  31,  31,  31,  31,  31,  31,  31,
		 31,  31,  31,  31,  31,  31,  31,  32,
		 32,  32,  32,  32,  32,  32,  32,  32,
		 32,  32,  32,  32,  32,  32,  32,  32,
		 32,  32,  32,  32,  32,  32,  32,  32,
		 33,  33,  33,  33,  33,  33,  33,  33,
		 33,  33,  33,  33,  33,  33,  33,  33,
		 33,  33,  33,  33,  33,  33,  33,  33,
		 34,  34,  34,  34,  34,  34,  34,  34,
		 34,  34,  34,  34,  34,  34,  34,  34,
		 34,  34,  34,  34,  34,  34,  34,  34,
		 35,  35,  35,  35,  35,  35,  35,  35,
		 35,  35,  35,  35,  35,  35,  35,  35,
		 35,  35,  35,  35,  35,  35,  35,  36,
		 36,  36,  36,  36,  36,  36,  36,  36,
		 36,  36,  36,  36,  36,  36,  36,  36,
		 36,  36,  36,  36,  36,  36,  37,  37,
		 37,  37,  37,  37,  37,  37,  37,  37,
		 37,  37,  37,  37,  37,  37,  37,  37,
		 37,  37,  37,  37,  37,  38,  38,  38,
		 38,  38,  38,  38,  38,  38,  38,  38,
		 38,  38,  38,  38,  38,  38,  38,  38,
		 38,  38,  38,  39,  39,  39,  39,  39,
		 39,  39,  39,  39,  39,  39,  39,  39,
		 39,  39,  39,  39,  39,  39,  39,  39,
		 40,  40,  40,  40,  40,  40,  40,  40,
		 40,  40,  40,  40,  40,  40,  40,  40,
		 40,  40,  40,  40,  40,  40,  41,  41,
		 41,  41,  41,  41,  41,  41,  41,  41,
		 41,  41,  41,  41,  41,  41,  41,  41,
		 41,  41,  41,  42,  42,  42,  42,  42,
		 42,  42,  42,  42,  42,  42,  42,  42,
		 42,  42,  42,  42,  42,  42,  42,  43,
		 43,  43,  43,  43,  43,  43,  43,  43,
		 43,  43,  43,  43,  43,  43,  43,  43,
		 43,  43,  43,  43,  44,  44,  44,  44,
		 44,  44,  44,  44,  44,  44,  44,  44,
		 44,  44,  44,  44,  44,  44,  44,  44,
		 45,  45,  45,  45,  45,  45,  45,  45,
		 45,  45,  45,  45,  45,  45,  45,  45,
		 45,  45,  45,  45,  46,  46,  46,  46,
		 46,  46,  46,  46,  46,  46,  46,  46,
		 46,  46,  46,  46,  46,  46,  46,  47,
		 47,  47,  47,  47,  47,  47,  47,  47,
		 47,  47,  47,  47,  47,  47,  47,  47,
		 47,  47,  48,  48,  48,  48,  48,  48,
		 48,  48,  48,  48,  48,  48,  48,  48,
		 48,  48,  48,  48,  48,  49,  49,  49,
		 49,  49,  49,  49,  49,  49,  49,  49,
		 49,  49,  49,  49,  49,  49,  49,  49,
		 50,  50,  50,  50,  50,  50,  50,  50,
		 50,  50,  50,  50,  50,  50,  50,  50,
		 50,  50,  51,  51,  51,  51,  51,  51,
		 51,  51,  51,  51,  51,  51,  51,  51,
		 51,  51,  51,  51,  52,  52,  52,  52,
		 52,  52,  52,  52,  52,  52,  52,  52,
		 52,  52,  52,  52,  52,  52,  53,  53,
		 53,  53,  53,  53,  53,  53,  53,  53,
		 53,  53,  53,  53,  53,  53,  53,  53,
		 54,  54,  54,  54,  54,  54,  54,  54,
		 54,  54,  54,  54,  54,  54,  54,  54,
		 54,  55,  55,  55,  55,  55,  55,  55,
		 55,  55,  55,  55,  55,  55,  55,  55,
		 55,  55,  55,  56,  56,  56,  56,  56,
		 56,  56,  56,  56,  56,  56,  56,  56,
		 56,  56,  56,  56,  57,  57,  57,  57,
		 57,  57,  57,  57,  57,  57,  57,  57,
		 57,  57,  57,  57,  57,  58,  58,  58,
		 58,  58,  58,  58,  58,  58,  58,  58,
		 58,  58,  58,  58,  58,  59,  59,  59,
		 59,  59,  59,  59,  59,  59,  59,  59,
		 59,  59,  59,  59,  59,  59,  60,  60,
		 60,  60,  60,  60,  60,  60,  60,  60,
		 60,  60,  60,  60,  60,  60,  61,  61,
		 61,  61,  61,  61,  61,  61,  61,  61,
		 61,  61,  61,  61,  61,  61,  62,  62,
		 62,  62,  62,  62,  62,  62,  62,  62,
		 62,  62,  62,  62,  62,  62,  63,  63,
		 63,  63,  63,  63,  63,  63,  63,  63,
		 63,  63,  63,  63,  63,  63,  64,  64,
		 64,  64,  64,  64,  64,  64,  64,  64,
		 64,  64,  64,  64,  64,  65,  65,  65,
		 65,  65,  65,  65,  65,  65,  65,  65,
		 65,  65,  65,  65,  65,  66,  66,  66,
		 66,  66,  66,  66,  66,  66,  66,  66,
		 66,  66,  66,  66,  67,  67,  67,  67,
		 67,  67,  67,  67,  67,  67,  67,  67,
		 67,  67,  67,  68,  68,  68,  68,  68,
		 68,  68,  68,  68,  68,  68,  68,  68,
		 68,  68,  69,  69,  69,  69,  69,  69,
		 69,  69,  69,  69,  69,  69,  69,  69,
		 69,  70,  70,  70,  70,  70,  70,  70,
		 70,  70,  70,  70,  70,  70,  70,  70,
		 71,  71,  71,  71,  71,  71,  71,  71,
		 71,  71,  71,  71,  71,  71,  72,  72,
		 72,  72,  72,  72,  72,  72,  72,  72,
		 72,  72,  72,  72,  72,  73,  73,  73,
		 73,  73,  73,  73,  73,  73,  73,  73,
		 73,  73,  73,  74,  74,  74,  74,  74,
		 74,  74,  74,  74,  74,  74,  74,  74,
		 74,  75,  75,  75,  75,  75,  75,  75,
		 75,  75,  75,  75,  75,  75,  75,  76,
		 76,  76,  76,  76,  76,  76,  76,  76,
		 76,  76,  76,  76,  76,  77,  77,  77,
		 77,  77,  77,  77,  77,  77,  77,  77,
		 77,  77,  77,  78,  78,  78,  78,  78,
		 78,  78,  78,  78,  78,  78,  78,  78,
		 78,  79,  79,  79,  79,  79,  79,  79,
		 79,  79,  79,  79,  79,  79,  80,  80,
		 80,  80,  80,  80,  80,  80,  80,  80,
		 80,  80,  80,  80,  81,  81,  81,  81,
		 81,  81,  81,  81,  81,  81,  81,  81,
		 81,  82,  82,  82,  82,  82,  82,  82,
		 82,  82,  82,  82,  82,  82,  83,  83,
		 83,  83,  83,  83,  83,  83,  83,  83,
		 83,  83,  83,  84,  84,  84,  84,  84,
		 84,  84,  84,  84,  84,  84,  84,  84,
		 85,  85,  85,  85,  85,  85,  85,  85,
		 85,  85,  85,  85,  85,  86,  86,  86,
		 86,  86,  86,  86,  86,  86,  86,  86,
		 86,  86,  87,  87,  87,  87,  87,  87,
		 87,  87,  87,  87,  87,  87,  87,  88,
		 88,  88,  88,  88,  88,  88,  88,  88,
		 88,  88,  88,  88,  89,  89,  89,  89,
		 89,  89,  89,  89,  89,  89,  89,  89,
		 90,  90,  90,  90,  90,  90,  90,  90,
		 90,  90,  90,  90,  91,  91,  91,  91,
		 91,  91,  91,  91,  91,  91,  91,  91,
		 91,  92,  92,  92,  92,  92,  92,  92,
		 92,  92,  92,  92,  92,  93,  93,  93,
		 93,  93,  93,  93,  93,  93,  93,  93,
		 93,  94,  94,  94,  94,  94,  94,  94,
		 94,  94,  94,  94,  94,  95,  95,  95,
		 95,  95,  95,  95,  95,  95,  95,  95,
		 95,  96,  96,  96,  96,  96,  96,  96,
		 96,  96,  96,  96,  96,  97,  97,  97,
		 97,  97,  97,  97,  97,  97,  97,  97,
		 97,  98,  98,  98,  98,  98,  98,  98,
		 98,  98,  98,  98,  98,  99,  99,  99,
		 99,  99,  99,  99,  99,  99,  99,  99,
		100, 100, 100, 100, 100, 100, 100, 100,
		100, 100, 100, 100, 101, 101, 101, 101,
		101, 101, 101, 101, 101, 101, 101, 101,
		102, 102, 102, 102, 102, 102, 102, 102,
		102, 102, 102, 103, 103, 103, 103, 103,
		103, 103, 103, 103, 103, 103, 104, 104,
		104, 104, 104, 104, 104, 104, 104, 104,
		104, 104, 105, 105, 105, 105, 105, 105,
		105, 105, 105, 105, 105, 106, 106, 106,
		106, 106, 106, 106, 106, 106, 106, 106,
		107, 107, 107, 107, 107, 107, 107, 107,
		107, 107, 107, 108, 108, 108, 108, 108,
		108, 108, 108, 108, 108, 108, 109, 109,
		109, 109, 109, 109, 109, 109, 109, 109,
		109, 110, 110, 110, 110, 110, 110, 110,
		110, 110, 110, 110, 111, 111, 111, 111,
		111, 111, 111, 111, 111, 111, 111, 112,
		112, 112, 112, 112, 112, 112, 112, 112,
		112, 113, 113, 113, 113, 113, 113, 113,
		113, 113, 113, 113, 114, 114, 114, 114,
		114, 114, 114, 114, 114, 114, 114, 115,
		115, 115, 115, 115, 115, 115, 115, 115,
		115, 116, 116, 116, 116, 116, 116, 116,
		116, 116, 116, 116, 117, 117, 117, 117,
		117, 117, 117, 117, 117, 117, 118, 118,
		118, 118, 118, 118, 118, 118, 118, 118,
		118, 119, 119, 119, 119, 119, 119, 119,
		119, 119, 119, 120, 120, 120, 120, 120,
		120, 120, 120, 120, 120, 121, 121, 121,
		121, 121, 121, 121, 121, 121, 121, 122,
		122, 122, 122, 122, 122, 122, 122, 122,
		122, 122, 123, 123, 123, 123, 123, 123,
		123, 123, 123, 123, 124, 124, 124, 124,
		124, 124, 124, 124, 124, 124, 125, 125,
		125, 125, 125, 125, 125, 125, 125, 125,
		126, 126, 126, 126, 126, 126, 126, 126,
		126, 126, 127, 127, 127, 127, 127, 127,
		127, 127, 127, 127, 128, 128, 128, 128,
		128, 128, 128, 128, 128, 129, 129, 129,
		129, 129, 129, 129, 129, 129, 129, 130,
		130, 130, 130, 130, 130, 130, 130, 130,
		130, 131, 131, 131, 131, 131, 131, 131,
		131, 131, 131, 132, 132, 132, 132, 132,
		132, 132, 132, 132, 133, 133, 133, 133,
		133, 133, 133, 133, 133, 133, 134, 134,
		134, 134, 134, 134, 134, 134, 134, 135,
		135, 135, 135, 135, 135, 135, 135, 135,
		135, 136, 136, 136, 136, 136, 136, 136,
		136, 136, 137, 137, 137, 137, 137, 137,
		137, 137, 137, 137, 138, 138, 138, 138,
		138, 138, 138, 138, 138, 139, 139, 139,
		139, 139, 139, 139, 139, 139, 140, 140,
		140, 140, 140, 140, 140, 140, 140, 140,
		141, 141, 141, 141, 141, 141, 141, 141,
		141, 142, 142, 142, 142, 142, 142, 142,
		142, 142, 143, 143, 143, 143, 143, 143,
		143, 143, 143, 144, 144, 144, 144, 144,
		144, 144, 144, 144, 145, 145, 145, 145,
		145, 145, 145, 145, 145, 146, 146, 146,
		146, 146, 146, 146, 146, 146, 147, 147,
		147, 147, 147, 147, 147, 147, 147, 148,
		148, 148, 148, 148, 148, 148, 148, 148,
		149, 149, 149, 149, 149, 149, 149, 149,
		149, 150, 150, 150, 150, 150, 150, 150,
		150, 150, 151, 151, 151, 151, 151, 151,
		151, 151, 151, 152, 152, 152, 152, 152,
		152, 152, 152, 153, 153, 153, 153, 153,
		153, 153, 153, 153, 154, 154, 154, 154,
		154, 154, 154, 154, 154, 155, 155, 155,
		155, 155, 155, 155, 155, 156, 156, 156,
		156, 156, 156, 156, 156, 156, 157, 157,
		157, 157, 157, 157, 157, 157, 157, 158,
		158, 158, 158, 158, 158, 158, 158, 159,
		159, 159, 159, 159, 159, 159, 159, 159,
		160, 160, 160, 160, 160, 160, 160, 160,
		161, 161, 161, 161, 161, 161, 161, 161,
		161, 162, 162, 162, 162, 162, 162, 162,
		162, 163, 163, 163, 163, 163, 163, 163,
		163, 164, 164, 164, 164, 164, 164, 164,
		164, 164, 165, 165, 165, 165, 165, 165,
		165, 165, 166, 166, 166, 166, 166, 166,
		166, 166, 167, 167, 167, 167, 167, 167,
		167, 167, 167, 168, 168, 168, 168, 168,
		168, 168, 168, 169, 169, 169, 169, 169,
		169, 169, 169, 170, 170, 170, 170, 170,
		170, 170, 170, 171, 171, 171, 171, 171,
		171, 171, 171, 172, 172, 172, 172, 172,
		172, 172, 172, 173, 173, 173, 173, 173,
		173, 173, 173, 174, 174, 174, 174, 174,
		174, 174, 174, 175, 175, 175, 175, 175,
		175, 175, 175, 176, 176, 176, 176, 176,
		176, 176, 176, 177, 177, 177, 177, 177,
		177, 177, 177, 178, 178, 178, 178, 178,
		178, 178, 178, 179, 179, 179, 179, 179,
		179, 179, 179, 180, 180, 180, 180, 180,
		180, 180, 180, 181, 181, 181, 181, 181,
		181, 181, 181, 182, 182, 182, 182, 182,
		182, 182, 183, 183, 183, 183, 183, 183,
		183, 183, 184, 184, 184, 184, 184, 184,
		184, 184, 185, 185, 185, 185, 185, 185,
		185, 186, 186, 186, 186, 186, 186, 186,
		186, 187, 187, 187, 187, 187, 187, 187,
		187, 188, 188, 188, 188, 188, 188, 188,
		189, 189, 189, 189, 189, 189, 189, 189,
		190, 190, 190, 190, 190, 190, 190, 191,
		191, 191, 191, 191, 191, 191, 191, 192,
		192, 192, 192, 192, 192, 192, 192, 193,
		193, 193, 193, 193, 193, 193, 194, 194,
		194, 194, 194, 194, 194, 195, 195, 195,
		195, 195, 195, 195, 195, 196, 196, 196,
		196, 196, 196, 196, 197, 197, 197, 197,
		197, 197, 197, 197, 198, 198, 198, 198,
		198, 198, 198, 199, 199, 199, 199, 199,
		199, 199, 200, 200, 200, 200, 200, 200,
		200, 200, 201, 201, 201, 201, 201, 201,
		201, 202, 202, 202, 202, 202, 202, 202,
		203, 203, 203, 203, 203, 203, 203, 204,
		204, 204, 204, 204, 204, 204, 204, 205,
		205, 205, 205, 205, 205, 205, 206, 206,
		206, 206, 206, 206, 206, 207, 207, 207,
		207, 207, 207, 207, 208, 208, 208, 208,
		208, 208, 208, 209, 209, 209, 209, 209,
		209, 209, 210, 210, 210, 210, 210, 210,
		210, 211, 211, 211, 211, 211, 211, 211,
		212, 212, 212, 212, 212, 212, 212, 213,
		213, 213, 213, 213, 213, 213, 214, 214,
		214, 214, 214, 214, 214, 215, 215, 215,
		215, 215, 215, 215, 216, 216, 216, 216,
		216, 216, 216, 217, 217, 217, 217, 217,
		217, 217, 218, 218, 218, 218, 218, 218,
		218, 219, 219, 219, 219, 219, 219, 219,
		220, 220, 220, 220, 220, 220, 220, 221,
		221, 221, 221, 221, 221, 221, 222, 222,
		222, 222, 222, 222, 223, 223, 223, 223,
		223, 223, 223, 224, 224, 224, 224, 224,
		224, 224, 225, 225, 225, 225, 225, 225,
		225, 226, 226, 226, 226, 226, 226, 227,
		227, 227, 227, 227, 227, 227, 228, 228,
		228, 228, 228, 228, 228, 229, 229, 229,
		229, 229, 229, 229, 230, 230, 230, 230,
		230, 230, 231, 231, 231, 231, 231, 231,
		231, 232, 232, 232, 232, 232, 232, 233,
		233, 233, 233, 233, 233, 233, 234, 234,
		234, 234, 234, 234, 234, 235, 235, 235,
		235, 235, 235, 236, 236, 236, 236, 236,
		236, 236, 237, 237, 237, 237, 237, 237,
		238, 238, 238, 238, 238, 238, 238, 239,
		239, 239, 239, 239, 239, 240, 240, 240,
		240, 240, 240, 240, 241, 241, 241, 241,
		241, 241, 242, 242, 242, 242, 242, 242,
		242, 243, 243, 243, 243, 243, 243, 244,
		244, 244, 244, 244, 244, 245, 245, 245,
		245, 245, 245, 245, 246, 246, 246, 246,
		246, 246, 247, 247, 247, 247, 247, 247,
		248, 248, 248, 248, 248, 248, 248, 249,
		249, 249, 249, 249, 249, 250, 250, 250,
		250, 250, 250, 251, 251, 251, 251, 251,
		251, 251, 252, 252, 252, 252, 252, 252,
		253, 253, 253, 253, 253, 253, 254, 254,
		254, 254, 254, 254, 255, 255, 255, 255,
};

static hc_pal_color_t hc_orange_pink_pal[256] = {
		{   0,    0,    0}, {   4,    4,    0}, {   8,    8,    0}, {  12,   12,    0},
		{  16,   16,    0}, {  20,   20,    0}, {  24,   24,    0}, {  28,   28,    0},
		{  32,   32,    0}, {  36,   36,    0}, {  40,   40,    0}, {  44,   44,    0},
		{  48,   48,    0}, {  52,   52,    0}, {  56,   56,    0}, {  60,   60,    0},
		{  64,   64,    0}, {  68,   68,    0}, {  72,   72,    0}, {  76,   76,    0},
		{  80,   80,    0}, {  84,   84,    0}, {  88,   88,    0}, {  92,   92,    0},
		{  96,   96,    0}, { 100,  100,    0}, { 104,  104,    0}, { 108,  108,    0},
		{ 112,  112,    0}, { 116,  116,    0}, { 120,  120,    0}, { 124,  124,    0},
		{ 128,  128,    0}, { 132,  132,    0}, { 136,  136,    0}, { 140,  140,    0},
		{ 144,  144,    0}, { 148,  148,    0}, { 152,  152,    0}, { 156,  156,    0},
		{ 160,  160,    0}, { 164,  164,    0}, { 168,  168,    0}, { 172,  172,    0},
		{ 176,  176,    0}, { 180,  180,    0}, { 184,  184,    0}, { 188,  188,    0},
		{ 192,  192,    0}, { 196,  196,    0}, { 200,  200,    0}, { 204,  204,    0},
		{ 208,  208,    0}, { 212,  212,    0}, { 216,  216,    0}, { 220,  220,    0},
		{ 224,  224,    0}, { 228,  228,    0}, { 232,  232,    0}, { 236,  236,    0},
		{ 240,  240,    0}, { 244,  244,    0}, { 248,  248,    0}, { 252,  252,    0},
		{ 256,  256,    0}, { 256,  258,    2}, { 256,  260,    4}, { 256,  262,    6},
		{ 256,  264,    8}, { 256,  266,   10}, { 256,  268,   12}, { 256,  270,   14},
		{ 256,  272,   16}, { 256,  274,   18}, { 256,  276,   20}, { 256,  278,   22},
		{ 256,  280,   24}, { 256,  282,   26}, { 256,  284,   28}, { 256,  286,   30},
		{ 256,  288,   32}, { 256,  290,   34}, { 256,  292,   36}, { 256,  294,   38},
		{ 256,  296,   40}, { 256,  298,   42}, { 256,  300,   44}, { 256,  302,   46},
		{ 256,  304,   48}, { 256,  306,   50}, { 256,  308,   52}, { 256,  310,   54},
		{ 256,  312,   56}, { 256,  314,   58}, { 256,  316,   60}, { 256,  318,   62},
		{ 256,  320,   64}, { 256,  322,   66}, { 256,  324,   68}, { 256,  326,   70},
		{ 256,  328,   72}, { 256,  330,   74}, { 256,  332,   76}, { 256,  334,   78},
		{ 256,  336,   80}, { 256,  338,   82}, { 256,  340,   84}, { 256,  342,   86},
		{ 256,  344,   88}, { 256,  346,   90}, { 256,  348,   92}, { 256,  350,   94},
		{ 256,  352,   96}, { 256,  354,   98}, { 256,  356,  100}, { 256,  358,  102},
		{ 256,  360,  104}, { 256,  362,  106}, { 256,  364,  108}, { 256,  366,  110},
		{ 256,  368,  112}, { 256,  370,  114}, { 256,  372,  116}, { 256,  374,  118},
		{ 256,  376,  120}, { 256,  378,  122}, { 256,  380,  124}, { 256,  382,  126},
		{ 256,  384,  128}, { 256,  386,  130}, { 256,  388,  132}, { 256,  390,  134},
		{ 256,  392,  136}, { 256,  394,  138}, { 256,  396,  140}, { 256,  398,  142},
		{ 256,  400,  144}, { 256,  402,  146}, { 256,  404,  148}, { 256,  406,  150},
		{ 256,  408,  152}, { 256,  410,  154}, { 256,  412,  156}, { 256,  414,  158},
		{ 256,  416,  160}, { 256,  418,  162}, { 256,  420,  164}, { 256,  422,  166},
		{ 256,  424,  168}, { 256,  426,  170}, { 256,  428,  172}, { 256,  430,  174},
		{ 256,  432,  176}, { 256,  434,  178}, { 256,  436,  180}, { 256,  438,  182},
		{ 256,  440,  184}, { 256,  442,  186}, { 256,  444,  188}, { 256,  446,  190},
		{ 256,  448,  192}, { 256,  450,  194}, { 256,  452,  196}, { 256,  454,  198},
		{ 256,  456,  200}, { 256,  458,  202}, { 256,  460,  204}, { 256,  462,  206},
		{ 256,  464,  208}, { 256,  466,  210}, { 256,  468,  212}, { 256,  470,  214},
		{ 256,  472,  216}, { 256,  474,  218}, { 256,  476,  220}, { 256,  478,  222},
		{ 256,  480,  224}, { 256,  482,  226}, { 256,  484,  228}, { 256,  486,  230},
		{ 256,  488,  232}, { 256,  490,  234}, { 256,  492,  236}, { 256,  494,  238},
		{ 256,  496,  240}, { 256,  498,  242}, { 256,  500,  244}, { 256,  502,  246},
		{ 256,  504,  248}, { 256,  506,  250}, { 256,  508,  252}, { 256,  510,  254},
		{2048,  512,  256}, {2080,  508,  260}, {2112,  504,  264}, {2144,  500,  268},
		{2176,  496,  272}, {2208,  492,  276}, {2240,  488,  280}, {2272,  484,  284},
		{2304,  480,  288}, {2336,  476,  292}, {2368,  472,  296}, {2400,  468,  300},
		{2432,  464,  304}, {2464,  460,  308}, {2496,  456,  312}, {2528,  452,  316},
		{2560,  448,  320}, {2592,  444,  324}, {2624,  440,  328}, {2656,  436,  332},
		{2688,  432,  336}, {2720,  428,  340}, {2752,  424,  344}, {2784,  420,  348},
		{2816,  416,  352}, {2848,  412,  356}, {2880,  408,  360}, {2912,  404,  364},
		{2944,  400,  368}, {2976,  396,  372}, {3008,  392,  376}, {3040,  388,  380},
		{3072,  384,  384}, {3104,  380,  388}, {3136,  376,  392}, {3168,  372,  396},
		{3200,  368,  400}, {3232,  364,  404}, {3264,  360,  408}, {3296,  356,  412},
		{3328,  352,  416}, {3360,  348,  420}, {3392,  344,  424}, {3424,  340,  428},
		{3456,  336,  432}, {3488,  332,  436}, {3520,  328,  440}, {3552,  324,  444},
		{3584,  320,  448}, {3616,  316,  452}, {3648,  312,  456}, {3680,  308,  460},
		{3712,  304,  464}, {3744,  300,  468}, {3776,  296,  472}, {3808,  292,  476},
		{3840,  288,  480}, {3872,  284,  484}, {3904,  280,  488}, {3936,  276,  492},
		{3968,  272,  496}, {4000,  268,  500}, {4032,  264,  504}, {4064,  260,  508},
};

static hc_color_t hc_lights[HC_NUM_LIGHTS];
static hc_color_t hc_lights_next[HC_NUM_LIGHTS];
static int32_t hc_powers[HC_NUM_LIGHTS];
static hc_pal_color_t hc_background;

static void hc_fill_i2s(void * buf, size_t buf_len);
static int32_t hc_compute_power(size_t sample_from, size_t sample_to);
static uint8_t hc_fix12_to_cie8(int32_t a);
static uint8_t hc_fix16_to_uint8(int32_t a);
static void hc_display_lights(void);
static void hc_generate_lights(int32_t power);

int main(void) {
	hw_assignment_id_t ld3, ld4, ld5, ld6;
	size_t last_audio_pos, cur_audio_pos;
	uint32_t last_tick;

	// Send a greeting to the trace device (skipped on Release).
	cu_log("Hello ARM World!\n");

	// At this stage the system clock should have already been configured
	// at high speed.
	cu_log("System clock: %u Hz\n", SystemCoreClock);

	ld3 = hw_pin_assign(HWR_PD12);
	ld4 = hw_pin_assign(HWR_PD13);
	ld5 = hw_pin_assign(HWR_PD14);
	ld6 = hw_pin_assign(HWR_PD15);

	hw_pin_configure(ld3, HWPM_OUT_PP);
	hw_pin_configure(ld4, HWPM_OUT_PP);
	hw_pin_configure(ld5, HWPM_OUT_PP);
	hw_pin_configure(ld6, HWPM_OUT_PP);

	hcp_init();

	cs43l22_start(hc_fill_i2s);

	__sync_synchronize();
	last_audio_pos = hc_audio_pos;
	last_tick = HAL_GetTick();

	for( ;; ) {
		uint32_t cur_tick = HAL_GetTick();
		int32_t power;

		if((uint32_t)(cur_tick - last_tick) < 5) {
			continue;
		}
		last_tick = cur_tick;

		hc_display_lights();

		__sync_synchronize();
		cur_audio_pos = hc_audio_pos;
		power = hc_compute_power(last_audio_pos, cur_audio_pos);
		last_audio_pos = cur_audio_pos;

		hc_generate_lights(power);
	}
}

void hc_fill_i2s(void * buf, size_t buf_len) {
	uint16_t * sample_buf = (uint16_t *)buf;
	size_t frames = buf_len / (sizeof (uint16_t) * 2);
	size_t audio_pos_temp = hc_audio_pos;

	for(size_t i = 0; i < frames; ++i) {
		uint16_t s = (uint16_t)hd_heartbeat_data[audio_pos_temp];
		*sample_buf++ = s;
		*sample_buf++ = s;
		++audio_pos_temp;
		if(audio_pos_temp >= cu_lengthof(hd_heartbeat_data)) {
			audio_pos_temp = 0;
		}
	}
	hc_audio_pos = audio_pos_temp;
	__sync_synchronize();
}

int32_t hc_compute_power(size_t sample_from, size_t sample_to) {
	int32_t maxs = 0;

	cu_verify(sample_from < cu_lengthof(hd_heartbeat_data));
	cu_verify(sample_to < cu_lengthof(hd_heartbeat_data));

	for(size_t i = sample_from; i != sample_to; ) {
		int32_t as = abs((int32_t)hd_heartbeat_data[i]);
		if(as > maxs) {
			maxs = as;
		}
		++i;
		if(i >= cu_lengthof(hd_heartbeat_data)) {
			i = 0;
		}
	}
	return maxs;
}

uint8_t hc_fix12_to_cie8(int32_t a) {
	if(a > 4095) {
		return 255;
	} else if(a < 0) {
		return 0;
	} else {
		return hc_cie_table[a];
	}
}

uint8_t hc_fix16_to_uint8(int32_t a) {
	if(a > 65535) {
		return 255;
	} else if(a < 0) {
		return 0;
	} else {
		return (uint8_t)(a >> 8);
	}
}

void hc_display_lights(void) {
	memcpy(&hc_lights, &hc_lights_next, sizeof hc_lights);
	ws2801_output(&hc_lights, sizeof hc_lights);
}

void hc_generate_lights(int32_t power) {
	int32_t hc_powers_next[HC_NUM_LIGHTS];
	int r = rand();

	hc_powers[r % 5] += power * 6;

	for(size_t i = 0; i < HC_NUM_LIGHTS; ++i) {
		int32_t p = hc_powers[i] * 10;
		if(i > 0) {
			p += hc_powers[i - 1] * 22;
		}
		p = p / 32;
		hc_powers_next[i] = p;
	}
	memcpy(hc_powers, hc_powers_next, sizeof hc_powers);
	hc_background.r += (int32_t)((r & 1) >> 0);
	hc_background.r -= (int32_t)((r & 2) >> 1);
	hc_background.g += (int32_t)((r & 4) >> 2);
	hc_background.g -= (int32_t)((r & 8) >> 3);
	hc_background.b += (int32_t)((r & 16) >> 4);
	hc_background.b -= (int32_t)((r & 32) >> 5);
	if(hc_background.r > 1023) {
		hc_background.r = 1023;
	}
	if(hc_background.g > 1023) {
		hc_background.g = 1023;
	}
	if(hc_background.b > 1023) {
		hc_background.b = 1023;
	}
	if(hc_background.r < 0) {
		hc_background.r = 0;
	}
	if(hc_background.g < 0) {
		hc_background.g = 0;
	}
	if(hc_background.b < 0) {
		hc_background.b = 0;
	}

	for(size_t i = 0; i < HC_NUM_LIGHTS; ++i) {
		int32_t p = hc_powers[i];
		int32_t cr = hc_orange_pink_pal[hc_fix16_to_uint8(p)].r;
		int32_t cg = hc_orange_pink_pal[hc_fix16_to_uint8(p)].g;
		int32_t cb = hc_orange_pink_pal[hc_fix16_to_uint8(p)].b;
		hc_color_t c;

		c.r = hc_fix12_to_cie8(cr + hc_background.r);
		c.g = hc_fix12_to_cie8(cg + hc_background.g);
		c.b = hc_fix12_to_cie8(cb + hc_background.b);

		hc_lights_next[i] = c;
	}
}

void cu_abort(void) {
#if defined(DEBUG)
	__DEBUG_BKPT();
#endif
	for( ;; ) {
	}
}

void cu_log(char const * format, ...) {
	static char buf[1000];

	int written;
	va_list ap;

	va_start(ap, format);

	written = vsnprintf(buf, sizeof(buf), format, ap);
	if (written > 0) {
		trace_write(buf, (size_t) written);
	}

	va_end(ap);
}

